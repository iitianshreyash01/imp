<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couple's Truth or Dare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
        }
        
        .display-font {
            font-family: 'Playfair Display', serif;
        }
        
        /* Custom Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.3); }
            50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.6); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .float-animation { animation: float 3s ease-in-out infinite; }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        .shimmer-bg {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #ec4899, #8b5cf6); 
            border-radius: 10px;
        }
        
        /* Particle Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.8), transparent);
            border-radius: 50%;
            animation: particle-float 15s infinite ease-in-out;
        }
        
        @keyframes particle-float {
            0%, 100% { transform: translate(0, 0); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
        }
        
        /* Button Styles */
        .btn-primary {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ec4899;
            animation: confetti-fall 3s linear forwards;
            pointer-events: none;
            z-index: 9999;
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="min-h-screen relative">
    <!-- Particle Background -->
    <div class="particles" id="particles"></div>
    
    <!-- Gradient Background -->
    <div class="fixed inset-0 bg-gradient-to-br from-pink-50 via-purple-50 to-indigo-50 -z-10"></div>
    
    <!-- Main App Container -->
    <div id="app" class="min-h-screen flex flex-col relative z-10">
        <div class="flex-1 flex items-center justify-center">
            <div class="flex items-center gap-3 text-pink-600">
                <div class="spinner"></div>
                <span class="font-semibold">Connecting...</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://nlubybdxsfudqfddrchh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sdWJ5YmR4c2Z1ZHFmZGRyY2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODA5MTcsImV4cCI6MjA4NTQ1NjkxN30.We0PJQ8fK6t51mR8pOZa7_my5CAjad5JkBPAmZ3UznE';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==================== GAME DATA ====================
        const TRUTHS = [
            "What was your very first impression of me?",
            "What is one secret fantasy you've never told me?",
            "When did you realize you were in love with me?",
            "What is the most embarrassing thing you've done to get my attention?",
            "If we could travel anywhere tomorrow, where would you take me?",
            "What's your favorite physical feature of mine?",
            "What is one thing I do that drives you crazy (in a good or bad way)?",
            "Have you ever dreamt about me? If yes, what happened?",
            "What is the most romantic thing I've ever done for you?",
            "If you had to describe our relationship in one word, what would it be?",
            "What is your biggest fear regarding our relationship?",
            "What's a song that reminds you of me?",
            "Who is the better kisser?",
            "What's the funniest memory we have together?",
            "If you could change one thing about me, what would it be?",
            "What do you think our life will be like in 10 years?",
            "What was the moment you knew we had something special?",
            "What's the most thoughtful gift I've ever given you?",
            "If you could relive one day with me, which would it be?",
            "What's something you've always wanted to ask me but haven't?"
        ];

        const DARES = [
            "Give me a foot massage for 2 minutes.",
            "Let me scroll through your photo gallery for 1 minute.",
            "Do your best impression of me.",
            "Kiss me somewhere other than my lips.",
            "Send a voice note to your best friend saying you love them (without context).",
            "Post a picture of us on your story right now with a cheesy caption.",
            "Let me do your makeup (or draw on your face) however I want.",
            "Whisper something naughty in my ear.",
            "Slow dance with me to no music for 1 minute.",
            "Let me tickle you for 30 seconds without you laughing.",
            "Recreate our first kiss.",
            "Give me a piggyback ride around the room.",
            "Stare into my eyes for 60 seconds without blinking or laughing.",
            "Feed me a snack without using your hands.",
            "Let me write a status on your social media and leave it for 10 minutes.",
            "Serenade me with a romantic song.",
            "Do 10 push-ups while I sit on your back.",
            "Let me give you a new hairstyle.",
            "Write 'I love [partner's name]' on your hand and keep it there.",
            "Tell me three things you love about me while looking into my eyes."
        ];

        // ==================== STATE MANAGEMENT ====================
        const state = {
            userId: localStorage.getItem('userId') || (() => {
                const id = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', id);
                return id;
            })(),
            playerName: localStorage.getItem('playerName') || '',
            roomCode: '',
            gameId: null,
            gameState: null,
            loading: false,
            error: '',
            isWritingCustom: false,
            customText: '',
            copySuccess: false,
            channel: null,
            soundEnabled: true
        };

        // ==================== UTILITY FUNCTIONS ====================
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 translate-x-0 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            } text-white font-medium flex items-center gap-3`;
            notification.innerHTML = `
                <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}" class="w-5 h-5"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            lucide.createIcons();
            
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            
            particlesContainer.innerHTML = '';
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        function triggerConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = ['#ec4899', '#8b5cf6', '#f472b6', '#a855f7', '#fbbf24'][Math.floor(Math.random() * 5)];
                    confetti.style.animationDelay = '0s';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        function playSound(type) {
            if (!state.soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'success') {
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                } else if (type === 'click') {
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                }
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (err) {
                // Audio context might not be available
                console.log('Audio not available');
            }
        }

        // ==================== EVENT HANDLERS ====================
        
        window.updatePlayerName = (e) => { 
            state.playerName = e.target.value;
            localStorage.setItem('playerName', state.playerName);
            render(); 
        };
        
        window.updateRoomCode = (e) => { 
            state.roomCode = e.target.value.toUpperCase(); 
            render(); 
        };
        
        window.updateCustomText = (e) => { 
            state.customText = e.target.value; 
            render(); 
        };
        
        window.toggleCustomWriting = (val) => { 
            state.isWritingCustom = val;
            if (!val) state.customText = '';
            playSound('click');
            render();
            
            if (val) {
                setTimeout(() => {
                    const input = document.getElementById('customInput');
                    if (input) input.focus();
                }, 100);
            }
        };

        // ==================== GAME FUNCTIONS ====================
        
        window.createGame = async () => {
            if (!state.playerName.trim()) {
                state.error = "Please enter your name first!";
                playSound('click');
                render();
                return;
            }
            
            state.loading = true;
            state.error = '';
            playSound('click');
            render();

            try {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                
                const initialState = {
                    code: code,
                    players: [{ uid: state.userId, name: state.playerName, score: 0 }],
                    currentTurnIndex: 0,
                    currentQuestion: null,
                    currentType: null,
                    status: 'waiting',
                    history: [],
                    createdAt: Date.now()
                };

                // Insert without updated_at field
                const { error } = await supabaseClient
                    .from('game_rooms')
                    .insert([{ id: code, game_state: initialState }]);

                if (error) throw error;

                state.gameId = code;
                playSound('success');
                showNotification('Room created successfully!', 'success');
                subscribeToGame(code);
            } catch (err) {
                console.error('Create game error:', err);
                state.error = "Failed to create room: " + err.message;
                showNotification('Failed to create room', 'error');
            } finally {
                state.loading = false;
                render();
            }
        };

        window.joinGame = async () => {
            if (!state.playerName.trim()) {
                state.error = "Please enter your name first!";
                playSound('click');
                render();
                return;
            }
            if (!state.roomCode.trim()) {
                state.error = "Please enter a room code!";
                playSound('click');
                render();
                return;
            }
            
            state.loading = true;
            state.error = '';
            playSound('click');
            render();

            try {
                const targetGameId = state.roomCode.trim();
                
                const { data, error } = await supabaseClient
                    .from('game_rooms')
                    .select('*')
                    .eq('id', targetGameId)
                    .single();

                if (error || !data) throw new Error("Room not found!");

                const currentGameState = data.game_state;
                const isAlreadyIn = currentGameState.players.some(p => p.uid === state.userId);
                
                if (!isAlreadyIn) {
                    if (currentGameState.players.length >= 2) {
                        throw new Error("Room is full!");
                    }
                    
                    currentGameState.players.push({ 
                        uid: state.userId, 
                        name: state.playerName, 
                        score: 0 
                    });
                    currentGameState.status = 'playing';

                    // Update without updated_at field
                    const { error: updateError } = await supabaseClient
                        .from('game_rooms')
                        .update({ game_state: currentGameState })
                        .eq('id', targetGameId);
                    
                    if (updateError) throw updateError;
                    
                    triggerConfetti();
                }

                state.gameId = targetGameId;
                playSound('success');
                showNotification('Joined successfully!', 'success');
                subscribeToGame(targetGameId);
            } catch (err) {
                console.error('Join game error:', err);
                state.error = err.message;
                showNotification(err.message, 'error');
            } finally {
                state.loading = false;
                render();
            }
        };

        function subscribeToGame(gameId) {
            if (state.channel) {
                supabaseClient.removeChannel(state.channel);
            }

            // Fetch initial state
            supabaseClient
                .from('game_rooms')
                .select('*')
                .eq('id', gameId)
                .single()
                .then(({ data, error }) => {
                    if (data && !error) {
                        state.gameState = data.game_state;
                        render();
                    }
                });

            // Subscribe to real-time updates
            state.channel = supabaseClient
                .channel(`room_${gameId}`)
                .on(
                    'postgres_changes',
                    { 
                        event: 'UPDATE', 
                        schema: 'public', 
                        table: 'game_rooms', 
                        filter: `id=eq.${gameId}` 
                    },
                    (payload) => {
                        console.log('Update received:', payload);
                        
                        const newState = payload.new.game_state;
                        const oldQuestion = state.gameState?.currentQuestion;
                        const newQuestion = newState.currentQuestion;
                        
                        state.gameState = newState;
                        
                        // Reset custom writing if question changed
                        if (oldQuestion !== newQuestion) {
                            state.isWritingCustom = false;
                            state.customText = '';
                        }
                        
                        // Play sound for new questions
                        if (!oldQuestion && newQuestion) {
                            playSound('success');
                        }
                        
                        render();
                    }
                )
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                });
        }

        async function updateGameStateInDb(newState) {
            try {
                // Update without updated_at field
                const { error } = await supabaseClient
                    .from('game_rooms')
                    .update({ game_state: newState })
                    .eq('id', state.gameId);
                
                if (error) throw error;
            } catch (err) {
                console.error("Update error:", err);
                state.error = "Failed to sync. Please check your connection.";
                showNotification('Failed to sync', 'error');
                render();
            }
        }

        window.selectMode = async (mode) => {
            if (!state.gameState) return;
            
            playSound('click');
            const pool = mode === 'truth' ? TRUTHS : DARES;
            const randomQ = pool[Math.floor(Math.random() * pool.length)];
            
            const newState = { ...state.gameState };
            newState.currentType = mode;
            newState.currentQuestion = randomQ;

            await updateGameStateInDb(newState);
        };

        window.submitCustomQuestion = async () => {
            if (!state.customText.trim() || !state.gameState) return;
            
            playSound('success');
            const newState = { ...state.gameState };
            newState.currentQuestion = state.customText;

            await updateGameStateInDb(newState);
            
            state.isWritingCustom = false;
            state.customText = '';
            showNotification('Custom challenge sent!', 'success');
            render();
        };

        window.completeTurn = async () => {
            if (!state.gameState) return;
            
            playSound('success');
            triggerConfetti();
            
            const newState = { ...state.gameState };
            const currentPlayer = newState.players[newState.currentTurnIndex];
            
            // Update scores
            newState.players = newState.players.map(p => 
                p.uid === currentPlayer.uid ? { ...p, score: p.score + 1 } : p
            );
            
            // Add to history
            if (!newState.history) newState.history = [];
            newState.history.push({
                player: currentPlayer.name,
                type: newState.currentType,
                question: newState.currentQuestion,
                timestamp: Date.now()
            });

            // Move to next turn
            newState.currentTurnIndex = (newState.currentTurnIndex + 1) % newState.players.length;
            newState.currentQuestion = null;
            newState.currentType = null;

            await updateGameStateInDb(newState);
            showNotification('Turn completed!', 'success');
        };

        window.copyCode = () => {
            if (!state.gameState?.code) return;
            
            navigator.clipboard.writeText(state.gameState.code).then(() => {
                state.copySuccess = true;
                playSound('success');
                showNotification('Code copied!', 'success');
                render();
                setTimeout(() => { 
                    state.copySuccess = false; 
                    render(); 
                }, 2000);
            }).catch(() => {
                showNotification('Failed to copy', 'error');
            });
        };

        window.leaveGame = () => {
            if (confirm('Are you sure you want to leave this game?')) {
                if (state.channel) {
                    supabaseClient.removeChannel(state.channel);
                }
                state.gameId = null;
                state.gameState = null;
                state.roomCode = '';
                playSound('click');
                render();
            }
        };

        // ==================== RENDER FUNCTION ====================
        
        function render() {
            const app = document.getElementById('app');
            
            // LOBBY SCREEN
            if (!state.gameId) {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="w-full max-w-md">
                            <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden border border-white/50 fade-in-up">
                                <!-- Header -->
                                <div class="relative bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-600 p-8 text-center overflow-hidden">
                                    <div class="shimmer-bg absolute inset-0"></div>
                                    <div class="relative z-10">
                                        <div class="flex justify-center mb-4">
                                            <div class="relative">
                                                <i data-lucide="heart" class="w-20 h-20 text-white fill-white float-animation"></i>
                                                <i data-lucide="sparkles" class="absolute -top-2 -right-2 w-10 h-10 text-yellow-300"></i>
                                            </div>
                                        </div>
                                        <h1 class="text-4xl font-bold text-white mb-2 display-font">Truth or Dare</h1>
                                        <p class="text-pink-100 font-medium">Couple's Edition ❤️</p>
                                    </div>
                                </div>

                                <!-- Form -->
                                <div class="p-8 space-y-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2 ml-1">Your Name</label>
                                        <div class="relative">
                                            <i data-lucide="user" class="absolute left-4 top-4 w-5 h-5 text-pink-400"></i>
                                            <input 
                                                type="text" 
                                                value="${state.playerName}" 
                                                onchange="updatePlayerName(event)"
                                                oninput="updatePlayerName(event)"
                                                placeholder="Enter your name" 
                                                class="w-full pl-12 pr-4 py-4 bg-white border-2 border-pink-100 rounded-xl focus:ring-2 focus:ring-pink-400 focus:border-transparent outline-none text-slate-700 font-medium transition-all"
                                                autocomplete="off"
                                            >
                                        </div>
                                    </div>

                                    ${state.error ? `
                                        <div class="p-4 bg-red-50 border-2 border-red-200 text-red-700 text-sm rounded-xl flex items-start gap-3 fade-in-up">
                                            <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0 mt-0.5"></i>
                                            <span>${state.error}</span>
                                        </div>
                                    ` : ''}

                                    <button 
                                        onclick="createGame()" 
                                        ${state.loading ? 'disabled' : ''} 
                                        class="btn-primary w-full py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        ${state.loading ? `
                                            <div class="spinner"></div>
                                            <span>Creating...</span>
                                        ` : `
                                            <i data-lucide="plus-circle" class="w-6 h-6"></i>
                                            <span>Create New Game</span>
                                        `}
                                    </button>
                                    
                                    <div class="relative">
                                        <div class="absolute inset-0 flex items-center">
                                            <div class="w-full border-t-2 border-slate-200"></div>
                                        </div>
                                        <div class="relative flex justify-center">
                                            <span class="px-4 bg-white text-sm font-semibold text-slate-400 uppercase tracking-wider">Or Join</span>
                                        </div>
                                    </div>

                                    <div class="flex gap-3">
                                        <input 
                                            type="text" 
                                            value="${state.roomCode}" 
                                            onchange="updateRoomCode(event)"
                                            oninput="updateRoomCode(event)" 
                                            placeholder="CODE" 
                                            maxlength="4" 
                                            class="flex-1 px-4 py-4 bg-white border-2 border-pink-100 rounded-xl focus:ring-2 focus:ring-pink-400 focus:border-transparent outline-none text-center text-xl font-bold tracking-widest text-slate-700 uppercase transition-all"
                                            autocomplete="off"
                                        >
                                        <button 
                                            onclick="joinGame()" 
                                            ${state.loading ? 'disabled' : ''} 
                                            class="px-8 py-4 bg-white border-2 border-pink-500 text-pink-600 rounded-xl font-bold hover:bg-pink-50 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                        >
                                            ${state.loading ? `<div class="spinner !border-pink-500 !border-t-transparent"></div>` : `<i data-lucide="log-in" class="w-5 h-5"></i>`}
                                            <span>Join</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Info Footer -->
                            <div class="mt-6 text-center text-sm text-slate-500">
                                <p>Built with Supabase Realtime</p>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // LOADING SCREEN
            if (!state.gameState || !state.gameState.players) {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="bg-white/80 backdrop-blur-lg p-8 rounded-3xl shadow-2xl flex flex-col items-center gap-4">
                            <div class="spinner !w-12 !h-12 !border-4 !border-pink-200 !border-t-pink-600"></div>
                            <span class="font-semibold text-lg text-slate-700">Loading Room...</span>
                        </div>
                    </div>
                `;
                return;
            }

            // WAITING ROOM
            if (state.gameState.status === 'waiting') {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="w-full max-w-md">
                            <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl p-8 text-center fade-in-up">
                                <div class="mb-6 inline-flex p-6 bg-gradient-to-br from-pink-100 to-purple-100 rounded-full pulse-glow">
                                    <i data-lucide="users" class="w-12 h-12 text-pink-600"></i>
                                </div>
                                
                                <h2 class="text-3xl font-bold text-slate-800 mb-2 display-font">Waiting for Partner</h2>
                                <p class="text-slate-600 mb-8">Share this code with your special someone</p>
                                
                                <div 
                                    onclick="copyCode()" 
                                    class="bg-gradient-to-r from-pink-50 to-purple-50 p-6 rounded-2xl flex items-center justify-between mb-3 cursor-pointer hover:from-pink-100 hover:to-purple-100 transition-all border-2 border-pink-200 group"
                                >
                                    <span class="text-5xl font-mono font-black text-transparent bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text tracking-[0.3em]">${state.gameState.code}</span>
                                    <i data-lucide="${state.copySuccess ? 'check' : 'copy'}" class="w-7 h-7 ${state.copySuccess ? 'text-green-500' : 'text-pink-400 group-hover:text-pink-600'} transition-colors"></i>
                                </div>
                                
                                <div class="h-8 mb-6">
                                    ${state.copySuccess ? `
                                        <div class="text-green-600 font-semibold flex items-center justify-center gap-2 fade-in-up">
                                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                                            <span>Copied to clipboard!</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="flex items-center justify-center gap-3 text-slate-400 animate-pulse">
                                    <div class="spinner !w-5 !h-5 !border-2 !border-slate-300 !border-t-slate-600"></div>
                                    <span class="font-medium">Waiting for them to join...</span>
                                </div>

                                <button 
                                    onclick="leaveGame()" 
                                    class="mt-8 text-sm text-slate-400 hover:text-red-500 font-medium transition-colors"
                                >
                                    Leave Room
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // ACTIVE GAME
            const currentPlayer = state.gameState.players[state.gameState.currentTurnIndex];
            const isMyTurn = currentPlayer.uid === state.userId;
            const isTruth = state.gameState.currentType === 'truth';
            const player1 = state.gameState.players[0];
            const player2 = state.gameState.players[1];
            
            const headerHtml = `
                <header class="bg-white/60 backdrop-blur-xl rounded-2xl shadow-lg p-6 mb-8 border border-white/50 fade-in-up">
                    <div class="flex items-center justify-between">
                        <!-- Player 1 -->
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 flex items-center justify-center text-white font-black text-2xl shadow-lg ${state.gameState.currentTurnIndex === 0 ? 'ring-4 ring-blue-300 pulse-glow' : ''}">
                                    ${player1.name.charAt(0).toUpperCase()}
                                </div>
                                ${state.gameState.currentTurnIndex === 0 ? `
                                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 border-2 border-white rounded-full"></div>
                                ` : ''}
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 text-lg">${player1.name}</p>
                                <div class="flex items-center gap-2">
                                    <i data-lucide="trophy" class="w-4 h-4 text-yellow-500"></i>
                                    <span class="text-sm font-semibold text-slate-600">${player1.score} points</span>
                                </div>
                            </div>
                        </div>

                        <!-- VS Badge -->
                        <div class="hidden sm:flex items-center justify-center px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-white font-black text-sm shadow-lg">
                            <span>VS</span>
                        </div>

                        <!-- Player 2 -->
                        <div class="flex items-center gap-4 flex-row-reverse">
                            <div class="relative">
                                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-pink-400 to-rose-600 flex items-center justify-center text-white font-black text-2xl shadow-lg ${state.gameState.currentTurnIndex === 1 ? 'ring-4 ring-pink-300 pulse-glow' : ''}">
                                    ${player2.name.charAt(0).toUpperCase()}
                                </div>
                                ${state.gameState.currentTurnIndex === 1 ? `
                                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 border-2 border-white rounded-full"></div>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-slate-800 text-lg">${player2.name}</p>
                                <div class="flex items-center gap-2 justify-end">
                                    <span class="text-sm font-semibold text-slate-600">${player2.score} points</span>
                                    <i data-lucide="trophy" class="w-4 h-4 text-yellow-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
            `;

            let mainHtml = '';
            
            if (!state.gameState.currentQuestion) {
                // SELECTION MODE
                mainHtml = `
                    <div class="text-center w-full max-w-lg fade-in-up">
                        <div class="mb-10">
                            ${isMyTurn 
                                ? `
                                    <div class="mb-4">
                                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-green-100 text-green-700 rounded-full font-semibold">
                                            <i data-lucide="zap" class="w-5 h-5"></i>
                                            <span>Your Turn!</span>
                                        </div>
                                    </div>
                                    <h2 class="text-4xl font-black text-slate-800 display-font">Choose Your Challenge</h2>
                                `
                                : `
                                    <div class="flex flex-col items-center gap-4">
                                        <div class="relative">
                                            <div class="w-20 h-20 rounded-full bg-white p-1 shadow-2xl animate-bounce">
                                                <div class="w-full h-full rounded-full bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center text-3xl font-black text-slate-600">
                                                    ${currentPlayer.name.charAt(0)}
                                                </div>
                                            </div>
                                            <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 px-3 py-1 bg-slate-800 text-white text-xs font-bold rounded-full whitespace-nowrap">
                                                Thinking...
                                            </div>
                                        </div>
                                        <h2 class="text-3xl font-black text-slate-700 display-font">${currentPlayer.name} is choosing</h2>
                                    </div>
                                `
                            }
                        </div>
                        
                        ${isMyTurn ? `
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <!-- Truth Button -->
                                <button 
                                    onclick="selectMode('truth')" 
                                    class="btn-primary group relative overflow-hidden h-56 rounded-3xl bg-gradient-to-br from-blue-400 via-indigo-500 to-purple-600 text-white shadow-2xl hover:shadow-blue-500/50 hover:scale-105 active:scale-95 transition-all"
                                >
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
                                    <div class="relative z-10 flex flex-col items-center justify-center h-full p-6">
                                        <div class="mb-4 p-4 bg-white/20 rounded-full">
                                            <i data-lucide="message-circle" class="w-12 h-12"></i>
                                        </div>
                                        <span class="text-3xl font-black tracking-wider mb-2">TRUTH</span>
                                        <span class="text-blue-100 text-sm font-medium">Ask me anything</span>
                                    </div>
                                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/30"></div>
                                </button>

                                <!-- Dare Button -->
                                <button 
                                    onclick="selectMode('dare')" 
                                    class="btn-primary group relative overflow-hidden h-56 rounded-3xl bg-gradient-to-br from-rose-400 via-pink-500 to-red-600 text-white shadow-2xl hover:shadow-pink-500/50 hover:scale-105 active:scale-95 transition-all"
                                >
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
                                    <div class="relative z-10 flex flex-col items-center justify-center h-full p-6">
                                        <div class="mb-4 p-4 bg-white/20 rounded-full">
                                            <i data-lucide="flame" class="w-12 h-12"></i>
                                        </div>
                                        <span class="text-3xl font-black tracking-wider mb-2">DARE</span>
                                        <span class="text-pink-100 text-sm font-medium">Challenge accepted</span>
                                    </div>
                                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/30"></div>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // CARD MODE
                mainHtml = `
                    <div class="w-full max-w-2xl fade-in-up">
                        <div class="relative bg-white/80 backdrop-blur-lg rounded-3xl shadow-2xl overflow-hidden border-4 ${isTruth ? 'border-blue-200' : 'border-pink-200'}">
                            <!-- Card Header -->
                            <div class="relative py-6 px-8 flex items-center justify-center gap-3 ${isTruth ? 'bg-gradient-to-r from-blue-500 to-indigo-600' : 'bg-gradient-to-r from-rose-500 to-pink-600'} text-white">
                                <div class="shimmer-bg absolute inset-0"></div>
                                <i data-lucide="${isTruth ? 'message-circle' : 'flame'}" class="w-7 h-7 relative z-10"></i>
                                <span class="font-black tracking-widest text-xl uppercase relative z-10">${state.gameState.currentType}</span>
                            </div>

                            <!-- Question Card -->
                            <div class="p-10">
                                <div class="text-center mb-8">
                                    <p class="text-3xl font-bold text-slate-800 leading-relaxed display-font">${state.gameState.currentQuestion}</p>
                                </div>
                                
                                ${!isMyTurn ? `
                                    <div class="p-6 bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl border-2 border-slate-200">
                                        <div class="flex items-center justify-center gap-3 text-slate-600 mb-4">
                                            <div class="w-3 h-3 bg-slate-400 rounded-full animate-ping"></div>
                                            <span class="font-semibold">Waiting for ${currentPlayer.name} to complete...</span>
                                        </div>
                                        
                                        <!-- Custom Question Section -->
                                        <div class="mt-6 pt-6 border-t-2 border-slate-200">
                                            ${!state.isWritingCustom ? `
                                                <button 
                                                    onclick="toggleCustomWriting(true)" 
                                                    class="flex items-center justify-center gap-2 w-full px-4 py-3 text-sm text-slate-500 hover:text-pink-600 hover:bg-pink-50 font-semibold rounded-xl transition-all border-2 border-dashed border-slate-300 hover:border-pink-300"
                                                >
                                                    <i data-lucide="pen-line" class="w-5 h-5"></i>
                                                    <span>Write a custom ${state.gameState.currentType}!</span>
                                                </button>
                                            ` : `
                                                <div class="space-y-3 fade-in-up">
                                                    <textarea 
                                                        id="customInput" 
                                                        onchange="updateCustomText(event)"
                                                        oninput="updateCustomText(event)" 
                                                        class="w-full p-4 text-base border-2 border-pink-200 rounded-xl outline-none focus:border-pink-400 focus:ring-2 focus:ring-pink-200 bg-white resize-none transition-all" 
                                                        rows="3" 
                                                        placeholder="Type your custom challenge..."
                                                    >${state.customText}</textarea>
                                                    <div class="flex gap-3">
                                                        <button 
                                                            onclick="toggleCustomWriting(false)" 
                                                            class="px-6 py-3 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-xl transition-all"
                                                        >
                                                            Cancel
                                                        </button>
                                                        <button 
                                                            onclick="submitCustomQuestion()" 
                                                            ${!state.customText.trim() ? 'disabled' : ''} 
                                                            class="flex-1 px-6 py-3 text-sm font-bold text-white bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all"
                                                        >
                                                            <span>Send Challenge</span>
                                                            <i data-lucide="send" class="w-4 h-4"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Complete Button -->
                            ${isMyTurn ? `
                                <div class="p-6 bg-gradient-to-br from-slate-50 to-slate-100 border-t-2 border-slate-200">
                                    <button 
                                        onclick="completeTurn()" 
                                        class="btn-primary w-full py-5 rounded-2xl font-black text-xl text-white shadow-xl active:scale-95 flex items-center justify-center gap-3 ${isTruth ? 'bg-gradient-to-r from-blue-500 via-indigo-600 to-purple-700 hover:shadow-blue-500/50' : 'bg-gradient-to-r from-rose-500 via-pink-600 to-red-700 hover:shadow-pink-500/50'} transition-all"
                                    >
                                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                                        <span>Completed!</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // History Section
            let historyHtml = '';
            if (state.gameState.history && state.gameState.history.length > 0) {
                const historyItems = [...state.gameState.history].reverse().slice(0, 5).map((item, index) => `
                    <div class="flex items-start gap-4 p-4 bg-white/60 rounded-xl hover:bg-white/80 transition-all" style="animation-delay: ${index * 0.1}s">
                        <div class="flex-shrink-0">
                            <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-black uppercase ${item.type === 'truth' ? 'bg-blue-100 text-blue-700' : 'bg-rose-100 text-rose-700'}">
                                ${item.type}
                            </span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm">
                                <span class="font-bold text-slate-800">${item.player}</span>
                                <span class="text-slate-500 mx-1">was asked:</span>
                            </p>
                            <p class="text-sm text-slate-600 italic mt-1">"${item.question}"</p>
                        </div>
                    </div>
                `).join('');
                
                historyHtml = `
                    <div class="mt-10 bg-white/40 backdrop-blur-md rounded-2xl p-6 max-h-80 overflow-y-auto custom-scrollbar w-full max-w-2xl shadow-lg fade-in-up">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-black text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                <i data-lucide="history" class="w-4 h-4"></i>
                                Recent Activity
                            </h3>
                            <span class="text-xs text-slate-400 font-semibold">${state.gameState.history.length} total</span>
                        </div>
                        <div class="space-y-3">${historyItems}</div>
                    </div>
                `;
            }

            app.innerHTML = `
                <div class="min-h-screen p-4 md:p-8">
                    <div class="w-full max-w-4xl mx-auto">
                        <!-- Leave Button -->
                        <div class="flex justify-end mb-4">
                            <button 
                                onclick="leaveGame()" 
                                class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all flex items-center gap-2"
                            >
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                <span>Leave Game</span>
                            </button>
                        </div>

                        ${headerHtml}
                        
                        <div class="flex justify-center py-8">
                            ${mainHtml}
                        </div>
                        
                        <div class="flex justify-center">
                            ${historyHtml}
                        </div>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }

        // ==================== INITIALIZATION ====================
        
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            render();
        });

        // Initial render
        setTimeout(() => {
            createParticles();
            render();
        }, 100);
    </script>
</body>
</html>
